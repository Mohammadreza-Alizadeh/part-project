#!/bin/bash

if [[ "$EUID" -ne 0 ]]; then
    echo "Sorry your user dosen't have required permisions"
    echo "Try running this command using sudo or with root user"
    exit 1
fi


username=""
sources_sample_file_addr="/tmp/part.sources.list.tmp"
disable=false
port=2324
log_dir="/var/log/part-tool.log"
verbose=false

sudo tee $sources_sample_file_addr &>/dev/null << EOF 
# Generated By Alizadeh
deb http://deb.debian.org/debian/ bookworm main non-free non-free-firmware contrib
deb-src http://deb.debian.org/debian/ bookworm main non-free non-free-firmware contrib
EOF

main() {

    operation=$1
    shift
    options=$@

    validate_options $options
    
    case "$operation" in
    'create-user')
        log "create-user tool is started"
        source /usr/local/share/part-tools/create-user.sh
        exit_code=$?
        log "create-user tool is finished - exit code : $exit_code"
        exit $exit_code
        ;;

    'change-sources')
        log "change-source tool is started"
        source /usr/local/share/part-tools/change-sources.sh
        exit_code=$?
        log "change-source tool is finished - exit code : $exit_code"
        exit $exit_code
        ;;

    'config-ssh')
        log "config-ssh tool is started"
        source /usr/local/share/part-tools/config-ssh.sh
        exit_code=$?
        log "config-ssh tool is finished - exit code : $exit_code"
        exit $exit_code
        ;;
    
    'config-ntp')
        log "config-ntp tool is started"
        source /usr/local/share/part-tools/config-ntp.sh
        exit_code=$?
        log "config-ntp tool is finished - exit code : $exit_code"
        exit $exit_code
        ;;
    
    'setup-cron')
        log "setup-cron tool is started"
        source /usr/local/share/part-tools/setup-cron.sh
        exit_code=$?
        log "setup-cron tool is finished - exit code : $exit_code"
        exit $exit_code
        ;;
    
    'config-nftables')
        log "config-nftables tool is started"
        source /usr/local/share/part-tools/config-nft.sh 
        exit_code=$?
        log "config-nftables tool is finished - exit code : $exit_code"
        exit $exit_code
        ;;
    'all')

        log "create-user tool is started" show 
        source /usr/local/share/part-tools/create-user.sh
        exit_code=$?
        log "create-user tool is finished - exit code : $exit_code" show 

        log "change-source tool is started" show 
        source /usr/local/share/part-tools/change-sources.sh
        exit_code=$?
        log "change-source tool is finished - exit code : $exit_code" show 
        
        log "config-ssh tool is started" show 
        source /usr/local/share/part-tools/config-ssh.sh
        exit_code=$?
        log "config-ssh tool is finished - exit code : $exit_code" show 
        
        log "config-ntp tool is started" show 
        source /usr/local/share/part-tools/config-ntp.sh
        exit_code=$?
        log "config-ntp tool is finished - exit code : $exit_code" show 
        
        log "setup-cron tool is started" show 
        source /usr/local/share/part-tools/setup-cron.sh
        exit_code=$?
        log "setup-cron tool is finished - exit code : $exit_code" show 

        log "config-nftables tool is started"
        source /usr/local/share/part-tools/config-nft.sh 
        exit_code=$?
        log "config-nftables tool is finished - exit code : $exit_code"

        exit 0
        ;;
    *)
        usage
        exit 1
        ;;
    esac

}

log() {
    if [[ $verbose == "true" || "$2" == "show" ]]; then
        echo "$(date +'%Y-%m-%d %H:%M:%S') - $1" | sudo tee -a "$log_dir"
    else
        echo "$(date +'%Y-%m-%d %H:%M:%S') - $1" | sudo tee -a "$log_dir" >&/dev/null
    fi
}



validate_options (){

    while getopts "u:df:p:v" arg; do
        case $arg in
        u)
            username=$OPTARG
            log "Username set to: $username"
            ;;
        d)
            disable=true
            ;;
        f)
            sample_file=$OPTARG
            if [[ -f $sample_file ]]; then
                sudo cp $sample_file $sources_sample_file_addr
                if [[ $? -ne 0 ]]; then
                    log "Unable to copy sample file" show
                    log "we will use default sample" show 
                fi
            fi
            ;;
        p)
            re='^[0-9]+$'
            if ! [[ $port =~ $re ]] ; then
                log "$port is not a valid Port" show
                exit 1
            fi
            port=$OPTARG
            log "Port is set to: $port" 
            ;;
        v)
            verbose=true
            echo "verbose mode is on"
            ;;
        *)  
            echo "Invalid option : $arg" 
            exit 1;
            ;;
        esac
    done
}




usage() {
    cat <<EOF
=============================================================================================
*                         The Part Script Helper                                            *
*                                                                                           *
*  Welcome to the Arctic! This script helps you with system setup, creating users,          *
*  and configuring your system.                                                             *
*                                                                                           *
*  Command: part <task> [options]                                                           *
*                                                                                           *
*  Available Tasks:                                                                         *
*    create-user      Create a new user and add them to the sudo group.                     *    
*    change-sources   Update the system to use Debian 12 package sources.                   *
*    config-ssh       Set up SSH: change the port, show a welcome message, and lock root.   *
*    config-ntp       Configure the NTP service to sync time with the pool.ntp.org server.  *
*    setup-cron       Set up cron to collect system stats every 2 minutes.                  *
*    config-nftables  Block all incoming traffic except SSH and log Debian requests.        *
*    all              Do all of the above tasks in one go!                                  *
*                                                                                           *  
*  Options:                                                                                 *
*    -u  <username>   Set a username for 'create-user' task. (default: part)                *
*    -p  <port>       Set the SSH port for 'config-ssh' task. (default: 22)                 *
*    -d               Skip 'apt update' step in tasks.                                      *
*    -f  <file>       Use a custom file for 'change-sources' task.                          *
*    -v               Turn on the verbose mode, usefull for debug.                          *
*  Example Commands:                                                                        *
*    part create-user -u "alizadeh"                                                         *
*    part config-ssh -p 2324                                                                *
*    part all -u "alizadeh" -p 2324 -f "/path/to/sources.list" -d                           *
*                                                                                           *
*  Waddle wisely, and may your Linux commands run smooth like a penguin's dive!             *
=============================================================================================
EOF
}

main $@
